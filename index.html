<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¥æœ­ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ  v5.2 </title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(45deg, #2196F3, #21CBF3);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .main-content {
            padding: 30px;
        }

        .section {
            margin-bottom: 30px;
            padding: 25px;
            border-radius: 10px;
            background: #f8f9fa;
            border-left: 4px solid #2196F3;
        }

        .section h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }

        .debug-section {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            margin-bottom: 20px;
            padding: 15px;
        }

        .debug-section h3 {
            color: #856404;
            margin-bottom: 10px;
        }

        .debug-info {
            font-family: monospace;
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }

        .warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            margin-bottom: 20px;
            color: #856404;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .warning-header {
            padding: 15px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #ffeaa7;
            transition: background-color 0.3s ease;
        }

        .warning-header:hover {
            background: #ffd93d;
        }

        .warning-header h4 {
            margin: 0;
            color: #b45309;
        }

        .warning-toggle {
            font-size: 1.2rem;
            font-weight: bold;
            color: #b45309;
            transition: transform 0.3s ease;
        }

        .warning-content {
            padding: 0 15px;
            max-height: 0;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .warning-content.active {
            padding: 15px;
            max-height: 500px;
        }

        .warning.active .warning-toggle {
            transform: rotate(180deg);
        }

        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .input-group input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            min-width: 200px;
        }

        .input-group input:focus {
            outline: none;
            border-color: #2196F3;
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: linear-gradient(45deg, #2196F3, #21CBF3);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(33, 150, 243, 0.4);
        }

        .btn-danger {
            background: linear-gradient(45deg, #f44336, #ff6b6b);
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(244, 67, 54, 0.4);
        }

        .btn-success {
            background: linear-gradient(45deg, #4CAF50, #66BB6A);
            color: white;
            font-size: 16px;
            padding: 15px 30px;
            margin: 20px 0;
            width: 100%;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(76, 175, 80, 0.4);
        }

        .btn-warning {
            background: linear-gradient(45deg, #ff9800, #ffb74d);
            color: white;
        }

        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 152, 0, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: white;
            border-radius: 8px;
            margin-bottom: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .list-item:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.15);
        }

        .list-item .site-info {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1;
            margin-right: 10px;
        }

        .list-item .site-url {
            word-break: break-all;
        }

        .list-item .site-name {
            color: #666;
            font-style: italic;
            font-size: 0.9rem;
        }

        .storage-info {
            background: #e8f4fd;
            border: 1px solid #b3d9ff;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }

        .storage-info h5 {
            color: #1976d2;
            margin-bottom: 10px;
        }

        .storage-info p {
            color: #0066cc;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        .keyword-info {
            background: #e8f5e9;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #4CAF50;
        }

        .keyword-info h4 {
            color: #2e7d32;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .keyword-info p {
            color: #388e3c;
            line-height: 1.6;
        }

        .keyword-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border: 2px solid #e9ecef;
        }

        .fixed-keyword-tag {
            display: inline-flex;
            align-items: center;
            background: #e3f2fd;
            color: #1976d2;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            border: 1px solid #bbdefb;
            font-weight: 600;
        }

        .date-settings {
            background: #e8f4fd;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #2196F3;
        }

        .date-settings h4 {
            color: #1976d2;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .date-settings label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .date-settings input[type="checkbox"] {
            margin-right: 8px;
        }

        .results {
            background: #fff;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .results h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }

        .result-item {
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            border-left: 4px solid #4CAF50;
            background: #f1f8e9;
            transition: all 0.3s ease;
        }

        .result-item:hover {
            background: #e8f5e8;
            transform: translateY(-2px);
        }

        .result-item.low-confidence {
            border-left-color: #ff9800;
            background: #fff3e0;
        }

        .result-url {
            color: #2196F3;
            text-decoration: none;
            font-weight: 600;
            word-break: break-all;
        }

        .result-url:hover {
            text-decoration: underline;
        }

        .result-keywords {
            color: #666;
            font-size: 0.9rem;
            margin-top: 5px;
        }

        .confidence-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 8px;
        }

        .confidence-high {
            background: #4CAF50;
            color: white;
        }

        .confidence-medium {
            background: #ff9800;
            color: white;
        }

        .confidence-low {
            background: #f44336;
            color: white;
        }

        .url-debug {
            background: #f0f8ff;
            border: 1px solid #b3d9ff;
            border-radius: 4px;
            padding: 5px 8px;
            margin-top: 5px;
            font-size: 0.8rem;
            color: #0066cc;
        }

        .no-results {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 30px;
            background: #f5f5f5;
            border-radius: 8px;
        }

        .loading {
            text-align: center;
            padding: 20px;
        }

        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #2196F3;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: 600;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        @media (max-width: 768px) {
            .input-group {
                flex-direction: column;
            }
            
            .input-group input {
                min-width: 100%;
            }
            
            .list-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .keyword-container {
                gap: 8px;
            }

            .fixed-keyword-tag {
                font-size: 12px;
                padding: 6px 12px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>å»ºç¯‰è¨­å‚™å…¥æœ­ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ  v5.2</h1>
            <p>æ°¸ç¶šåŒ–å¯¾å¿œç‰ˆ - ç›£è¦–ã‚µã‚¤ãƒˆãƒªã‚¹ãƒˆãŒãƒ–ãƒ©ã‚¦ã‚¶ã‚’é–‰ã˜ã¦ã‚‚ä¿æŒã•ã‚Œã¾ã™</p>
        </div>

        <div class="main-content">
            <!-- ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="debug-section">
                <h3>ğŸ” ã‚·ã‚¹ãƒ†ãƒ ãƒ»ãƒ‡ãƒ¼ã‚¿æ°¸ç¶šåŒ–ãƒ‡ãƒãƒƒã‚°æƒ…å ±</h3>
                <div id="debugInfo" class="debug-info">ã‚·ã‚¹ãƒ†ãƒ èµ·å‹•ä¸­...</div>
            </div>

            <!-- é‡è¦ãªæ³¨æ„äº‹é … -->
            <div class="warning" id="warningSection">
                <div class="warning-header" onclick="toggleWarning()">
                    <h4>âš ï¸ v5.2 æ°¸ç¶šåŒ–å¯¾å¿œç‰ˆã®æ–°æ©Ÿèƒ½</h4>
                    <span class="warning-toggle">â–¼</span>
                </div>
                <div class="warning-content" id="warningContent">
                    <ul>
                        <li><strong>è‡ªå‹•ä¿å­˜æ©Ÿèƒ½:</strong> ã‚µã‚¤ãƒˆè¿½åŠ ãƒ»å‰Šé™¤æ™‚ã«è‡ªå‹•çš„ã«ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜</li>
                        <li><strong>è‡ªå‹•å¾©å…ƒæ©Ÿèƒ½:</strong> ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ä¿å­˜ã•ã‚ŒãŸã‚µã‚¤ãƒˆæƒ…å ±ã‚’è‡ªå‹•å¾©å…ƒ</li>
                        <li><strong>ãƒ‡ãƒ¼ã‚¿ç®¡ç†æ©Ÿèƒ½:</strong> ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ã‚ˆã‚‹ç¢ºå®Ÿãªãƒ‡ãƒ¼ã‚¿ä¿æŒ</li>
                        <li><strong>ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°:</strong> ä¿å­˜ãƒ»èª­ã¿è¾¼ã¿å¤±æ•—æ™‚ã®é©åˆ‡ãªå‡¦ç†</li>
                        <li><strong>æ—¢å­˜æ©Ÿèƒ½å®Œå…¨ä¿æŒ:</strong> ãƒªãƒ³ã‚¯ä¿®æ­£ãƒ»é«˜ç²¾åº¦æ—¥ä»˜æŠ½å‡ºæ©Ÿèƒ½ã‚‚ç¶­æŒ</li>
                    </ul>
                </div>
            </div>

            <!-- ã‚µã‚¤ãƒˆç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="section">
                <h2>ç›£è¦–ã‚µã‚¤ãƒˆç®¡ç†ï¼ˆæ°¸ç¶šåŒ–å¯¾å¿œï¼‰</h2>
                <div class="input-group">
                    <input type="url" id="siteInput" placeholder="ç›£è¦–ã™ã‚‹ã‚µã‚¤ãƒˆã®URLã‚’å…¥åŠ›" />
                    <input type="text" id="siteNameInput" placeholder="ã‚µã‚¤ãƒˆåï¼ˆä»»æ„ï¼‰" />
                    <button class="btn btn-primary" onclick="addSite()">ã‚µã‚¤ãƒˆè¿½åŠ </button>
                </div>
                
                <div class="storage-info" id="storageInfo">
                    <h5>ğŸ’¾ ãƒ‡ãƒ¼ã‚¿æ°¸ç¶šåŒ–çŠ¶æ³</h5>
                    <p id="storageStatus">èª­ã¿è¾¼ã¿ä¸­...</p>
                </div>

                <div id="siteList"></div>
            </div>

            <!-- å›ºå®šã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰è¡¨ç¤ºã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="section">
                <h2>ç›£è¦–ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼ˆå›ºå®šè¨­å®šï¼‰</h2>
                <div class="keyword-info">
                    <h4>ğŸ—ï¸ å»ºç¯‰ãƒ»è¨­å‚™ãƒ»ä¿®ç¹•é–¢é€£ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰</h4>
                    <p>ä»¥ä¸‹ã®29å€‹ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒè‡ªå‹•çš„ã«è¨­å®šã•ã‚Œã€ã“ã‚Œã‚‰ã‚’å«ã‚€æƒ…å ±ã‚’ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ã—ã¾ã™ã€‚</p>
                </div>
                <div class="keyword-container" id="keywordDisplay"></div>
            </div>

            <!-- ãƒ—ãƒ­ã‚­ã‚·è¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="section">
                <h2>ãƒ—ãƒ­ã‚­ã‚·è¨­å®š</h2>
                <div class="input-group">
                    <input type="text" id="proxyUrl" placeholder="ãƒ—ãƒ­ã‚­ã‚·ã‚µãƒ¼ãƒãƒ¼URL" value="https://api.allorigins.win/get" />
                    <input type="text" id="apiKey" placeholder="APIã‚­ãƒ¼ï¼ˆå¿…è¦ãªå ´åˆï¼‰" />
                </div>
            </div>

            <!-- ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°å®Ÿè¡Œã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="section">
                <h2>ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°å®Ÿè¡Œ</h2>
                <div class="date-settings">
                    <h4>ğŸ“… æ—¥ä»˜æŠ½å‡ºè¨­å®š</h4>
                    <div class="input-group">
                        <label>æ¤œç´¢æœŸé–“: </label>
                        <input type="number" id="dayRange" placeholder="éå»ä½•æ—¥é–“" value="7" min="1" max="30" />
                        <span>æ—¥é–“</span>
                    </div>
                    <label>
                        <input type="checkbox" id="includeUndated" />
                        æ—¥ä»˜ä¸æ˜ã®è¨˜äº‹ã‚‚å«ã‚ã‚‹
                    </label>
                    <label>
                        <input type="checkbox" id="showConfidence" checked />
                        æ—¥ä»˜ä¿¡é ¼åº¦ã‚’è¡¨ç¤ºã™ã‚‹
                    </label>
                    <label>
                        <input type="checkbox" id="showUrlDebug" checked />
                        URLå¤‰æ›éç¨‹ã‚’è¡¨ç¤ºã™ã‚‹
                    </label>
                </div>
                <button class="btn btn-success" id="scrapeBtn" onclick="startScraping()">
                    æ°¸ç¶šåŒ–å¯¾å¿œç‰ˆã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°é–‹å§‹
                </button>
                <div id="statusMessage"></div>
            </div>

            <!-- çµæœè¡¨ç¤ºã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="results">
                <h3>ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°çµæœ</h3>
                <div id="results">
                    <div class="no-results">ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å›ºå®šã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒªã‚¹ãƒˆ
        const FIXED_KEYWORDS = [
            'å…¥æœ­', 'å…¬å‘Š', 'ç«¶äº‰', 'ã‚ªãƒ¼ãƒ—ãƒ³ã‚«ã‚¦ãƒ³ã‚¿', 'OC',
            'æ”¹ä¿®', 'æ”¹è£…', 'å·¥äº‹', 'é˜²æ°´', 'å¡—è£…', 'å£', 'å»ºç‰©',
            'å±‹ä¸Š', 'å±‹æ ¹', 'ä½œæ¥­', 'ä¿®ç¹•', 'è£œä¿®', 'å»ºç¯‰', 'åºŠ',
            'ãƒˆã‚¤ãƒ¬', 'ç…§æ˜', 'è¨­å‚™', 'ç©ºèª¿', 'å†…è£…', 'é›¨æ¼ã‚Š',
            'æ¼æ°´', 'æ°´æ¼ã‚Œ', 'å¾©æ—§', 'ä¾¿å™¨'
        ];

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let sites = [];
        let keywords = [...FIXED_KEYWORDS];

        // â˜…â˜…â˜… æ°¸ç¶šåŒ–æ©Ÿèƒ½ â˜…â˜…â˜…
        const STORAGE_KEY = 'scraping_system_sites_v52';

        // ãƒ‡ãƒ¼ã‚¿ä¿å­˜æ©Ÿèƒ½
        function saveSitesToStorage() {
            try {
                const dataToSave = {
                    version: '5.2',
                    timestamp: new Date().toISOString(),
                    sites: sites
                };
                localStorage.setItem(STORAGE_KEY, JSON.stringify(dataToSave));
                debugLog(`ğŸ’¾ ã‚µã‚¤ãƒˆãƒ‡ãƒ¼ã‚¿ä¿å­˜å®Œäº†: ${sites.length}ä»¶`);
                updateStorageInfo();
                return true;
            } catch (error) {
                debugLog(`âŒ ä¿å­˜ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                showStatus('ãƒ‡ãƒ¼ã‚¿ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                return false;
            }
        }

        // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿æ©Ÿèƒ½
        function loadSitesFromStorage() {
            try {
                const storedData = localStorage.getItem(STORAGE_KEY);
                if (!storedData) {
                    debugLog('ğŸ“ ä¿å­˜ãƒ‡ãƒ¼ã‚¿ãªã—ï¼ˆåˆå›èµ·å‹•ï¼‰');
                    return [];
                }

                const parsedData = JSON.parse(storedData);
                
                // ãƒ‡ãƒ¼ã‚¿å½¢å¼ã®æ¤œè¨¼
                if (parsedData.sites && Array.isArray(parsedData.sites)) {
                    debugLog(`ğŸ“‚ ã‚µã‚¤ãƒˆãƒ‡ãƒ¼ã‚¿å¾©å…ƒ: ${parsedData.sites.length}ä»¶ (ä¿å­˜æ—¥æ™‚: ${parsedData.timestamp})`);
                    return parsedData.sites;
                } else {
                    debugLog('âŒ ç„¡åŠ¹ãªãƒ‡ãƒ¼ã‚¿å½¢å¼');
                    return [];
                }
            } catch (error) {
                debugLog(`âŒ èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                showStatus('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
                return [];
            }
        }

        // ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸æƒ…å ±æ›´æ–°
        function updateStorageInfo() {
            const statusElement = document.getElementById('storageStatus');
            if (!statusElement) return;

            try {
                const storedData = localStorage.getItem(STORAGE_KEY);
                if (storedData) {
                    const data = JSON.parse(storedData);
                    const saveDate = new Date(data.timestamp).toLocaleString('ja-JP');
                    statusElement.innerHTML = `
                        ä¿å­˜ã‚µã‚¤ãƒˆæ•°: ${sites.length}ä»¶ | 
                        æœ€çµ‚ä¿å­˜: ${saveDate} | 
                        ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚º: ${(storedData.length / 1024).toFixed(1)} KB
                    `;
                } else {
                    statusElement.innerHTML = 'æœªä¿å­˜ï¼ˆã‚µã‚¤ãƒˆã‚’è¿½åŠ ã™ã‚‹ã¨è‡ªå‹•ä¿å­˜ã•ã‚Œã¾ã™ï¼‰';
                }
            } catch (error) {
                statusElement.innerHTML = 'ä¿å­˜çŠ¶æ³ã®å–å¾—ã«å¤±æ•—';
            }
        }

        // ã‚µã‚¤ãƒˆãƒªã‚¹ãƒˆè¡¨ç¤ºæ›´æ–°
        function refreshSiteList() {
            const siteList = document.getElementById('siteList');
            siteList.innerHTML = '';
            sites.forEach(site => addSiteToList(site));
        }

        // æ—¥ä»˜ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
        function toHalfWidth(str) {
            if (!str) return '';
            return str.replace(/[ï¼¡-ï¼ºï½-ï½šï¼-ï¼™]/g, ch => 
                String.fromCharCode(ch.charCodeAt(0) - 0xFEE0)
            ).replace(/[ï¼â€•ãƒ¼â€“]/g, '-').replace(/[ï¼]/g, '/');
        }

        function makeJSTDate(year, month, day, hour = 0, minute = 0, second = 0) {
            try {
                const date = new Date(year, month - 1, day, hour, minute, second);
                return isNaN(date.getTime()) ? null : date;
            } catch (e) {
                return null;
            }
        }

        function eraToWesternYear(era, year) {
            const eraMap = {
                'ä»¤å’Œ': 2018,
                'å¹³æˆ': 1988,
                'æ˜­å’Œ': 1925,
                'å¤§æ­£': 1911
            };
            
            if (!(era in eraMap)) return null;
            const yearNum = (year === 'å…ƒ') ? 1 : parseInt(year, 10);
            return eraMap[era] + yearNum;
        }

        // é«˜ç²¾åº¦æ—¥ä»˜æŠ½å‡ºã‚·ã‚¹ãƒ†ãƒ 
        function extractDateWithHighPrecision(element, doc, baseDate = new Date()) {
            const candidates = [];
            
            // 1. JSON-LDæ§‹é€ åŒ–ãƒ‡ãƒ¼ã‚¿ï¼ˆæœ€é«˜ç²¾åº¦ï¼‰
            try {
                const jsonScripts = doc.querySelectorAll('script[type="application/ld+json"]');
                for (const script of jsonScripts) {
                    const data = JSON.parse(script.textContent);
                    const dateFields = ['datePublished', 'dateCreated', 'uploadDate', 'dateModified'];
                    
                    function extractFromJson(obj) {
                        if (!obj || typeof obj !== 'object') return;
                        
                        for (const field of dateFields) {
                            if (obj[field]) {
                                const date = parseAdvancedDate(obj[field], baseDate);
                                if (date) {
                                    candidates.push({
                                        date: date,
                                        confidence: 'high',
                                        source: `JSON-LD:${field}`
                                    });
                                }
                            }
                        }
                        
                        if (Array.isArray(obj)) {
                            obj.forEach(extractFromJson);
                        } else if (typeof obj === 'object') {
                            Object.values(obj).forEach(extractFromJson);
                        }
                    }
                    
                    extractFromJson(data);
                }
            } catch (e) {
                // JSON-LDè§£æã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–
            }

            // 2. ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ï¼ˆé«˜ç²¾åº¦ï¼‰
            const metaSelectors = [
                'meta[property="article:published_time"]',
                'meta[property="article:modified_time"]',
                'meta[name="publication-date"]',
                'meta[name="date"]',
                'meta[property="og:updated_time"]'
            ];
            
            for (const selector of metaSelectors) {
                const meta = doc.querySelector(selector);
                if (meta) {
                    const content = meta.getAttribute('content');
                    const date = parseAdvancedDate(content, baseDate);
                    if (date) {
                        candidates.push({
                            date: date,
                            confidence: 'high',
                            source: `ãƒ¡ã‚¿:${selector.split('[')[1]?.split(']')[0]}`
                        });
                    }
                }
            }

            // 3. HTMLæ§‹é€ åŒ–è¦ç´ ï¼ˆä¸­ç²¾åº¦ï¼‰
            const dateSelectors = [
                'time[datetime]',
                '.date', '.datetime', '.published', '.post-date',
                '[class*="date"]', '[class*="time"]'
            ];
            
            for (const selector of dateSelectors) {
                const elements = element.querySelectorAll(selector);
                elements.forEach(el => {
                    const datetime = el.getAttribute('datetime');
                    const text = el.textContent;
                    
                    if (datetime) {
                        const date = parseAdvancedDate(datetime, baseDate);
                        if (date) {
                            candidates.push({
                                date: date,
                                confidence: 'high',
                                source: `HTML:${selector}[datetime]`
                            });
                        }
                    }
                    
                    if (text) {
                        const date = parseAdvancedDate(text, baseDate);
                        if (date) {
                            candidates.push({
                                date: date,
                                confidence: 'medium',
                                source: `HTML:${selector}`
                            });
                        }
                    }
                });
            }

            // 4. ãƒ†ã‚­ã‚¹ãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒãƒ³ã‚°ï¼ˆä½ç²¾åº¦ï¼‰
            const elementText = element.textContent || element.innerText || '';
            const textDate = parseAdvancedDate(elementText, baseDate);
            if (textDate) {
                candidates.push({
                    date: textDate,
                    confidence: 'low',
                    source: 'ãƒ†ã‚­ã‚¹ãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³'
                });
            }

            // å€™è£œã‹ã‚‰æœ€é©ãªã‚‚ã®ã‚’é¸æŠ
            if (candidates.length === 0) {
                return null;
            }

            // æœ‰åŠ¹æ€§ãƒã‚§ãƒƒã‚¯
            const now = new Date();
            const oneYearAgo = new Date(now.getFullYear() - 1, now.getMonth(), now.getDate());
            const oneWeekFuture = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);
            
            const validCandidates = candidates.filter(c => 
                c.date >= oneYearAgo && c.date <= oneWeekFuture
            );

            if (validCandidates.length === 0) {
                return null;
            }

            // ä¿¡é ¼åº¦é †ã§ã‚½ãƒ¼ãƒˆ
            const confidenceOrder = { 'high': 3, 'medium': 2, 'low': 1 };
            validCandidates.sort((a, b) => {
                const confDiff = confidenceOrder[b.confidence] - confidenceOrder[a.confidence];
                return confDiff !== 0 ? confDiff : b.date - a.date;
            });

            const best = validCandidates[0];
            debugLog(`âœ… æ—¥ä»˜æŠ½å‡ºæˆåŠŸ: ${best.date.toISOString()} (ä¿¡é ¼åº¦: ${best.confidence})`);
            
            return best;
        }

        // åŒ…æ‹¬çš„æ—¥ä»˜ãƒ‘ãƒ¼ã‚¹é–¢æ•°
        function parseAdvancedDate(dateStr, baseDate = new Date()) {
            if (!dateStr || typeof dateStr !== 'string') return null;
            
            const normalized = toHalfWidth(dateStr.trim());
            
            // ç›¸å¯¾æ—¥ä»˜å‡¦ç†
            if (/æœ¬æ—¥|ä»Šæ—¥/.test(normalized)) {
                return makeJSTDate(baseDate.getFullYear(), baseDate.getMonth() + 1, baseDate.getDate());
            }
            if (/æ˜¨æ—¥/.test(normalized)) {
                const yesterday = new Date(baseDate.getTime() - 24 * 60 * 60 * 1000);
                return makeJSTDate(yesterday.getFullYear(), yesterday.getMonth() + 1, yesterday.getDate());
            }
            if (/ä¸€æ˜¨æ—¥/.test(normalized)) {
                const dayBefore = new Date(baseDate.getTime() - 2 * 24 * 60 * 60 * 1000);
                return makeJSTDate(dayBefore.getFullYear(), dayBefore.getMonth() + 1, dayBefore.getDate());
            }
            
            const relativeMatch = normalized.match(/(\d+)\s*æ—¥å‰/);
            if (relativeMatch) {
                const daysAgo = parseInt(relativeMatch[1], 10);
                const targetDate = new Date(baseDate.getTime() - daysAgo * 24 * 60 * 60 * 1000);
                return makeJSTDate(targetDate.getFullYear(), targetDate.getMonth() + 1, targetDate.getDate());
            }

            // ISOå½¢å¼
            const isoMatch = normalized.match(/(\d{4})-(\d{1,2})-(\d{1,2})(?:T(\d{1,2}):(\d{1,2}):(\d{1,2}))?/);
            if (isoMatch) {
                return makeJSTDate(
                    parseInt(isoMatch[1], 10),
                    parseInt(isoMatch[2], 10),
                    parseInt(isoMatch[3], 10),
                    parseInt(isoMatch[4] || '0', 10),
                    parseInt(isoMatch[5] || '0', 10),
                    parseInt(isoMatch[6] || '0', 10)
                );
            }

            // æ—¥æœ¬èªè¡¨è¨˜: YYYYå¹´MMæœˆDDæ—¥
            const jpMatch = normalized.match(/(\d{4})\s*å¹´\s*(\d{1,2})\s*æœˆ\s*(\d{1,2})\s*æ—¥/);
            if (jpMatch) {
                return makeJSTDate(
                    parseInt(jpMatch[1], 10),
                    parseInt(jpMatch[2], 10),
                    parseInt(jpMatch[3], 10)
                );
            }

            // å’Œæš¦: ä»¤å’ŒXå¹´MMæœˆDDæ—¥
            const eraMatch = normalized.match(/(ä»¤å’Œ|å¹³æˆ|æ˜­å’Œ|å¤§æ­£)\s*(å…ƒ|\d+)\s*å¹´\s*(\d{1,2})\s*æœˆ\s*(\d{1,2})\s*æ—¥/);
            if (eraMatch) {
                const westernYear = eraToWesternYear(eraMatch[1], eraMatch[2]);
                if (westernYear) {
                    return makeJSTDate(
                        westernYear,
                        parseInt(eraMatch[3], 10),
                        parseInt(eraMatch[4], 10)
                    );
                }
            }

            // å’Œæš¦ç•¥è¨˜: R6.1.5
            const eraShortMatch = normalized.match(/([RrHhSs])(\d+)\.(\d{1,2})\.(\d{1,2})/);
            if (eraShortMatch) {
                const eraMap = { 'R': 'ä»¤å’Œ', 'r': 'ä»¤å’Œ', 'H': 'å¹³æˆ', 'h': 'å¹³æˆ', 'S': 'æ˜­å’Œ', 's': 'æ˜­å’Œ' };
                const era = eraMap[eraShortMatch[1]];
                if (era) {
                    const westernYear = eraToWesternYear(era, eraShortMatch[2]);
                    if (westernYear) {
                        return makeJSTDate(
                            westernYear,
                            parseInt(eraShortMatch[3], 10),
                            parseInt(eraShortMatch[4], 10)
                        );
                    }
                }
            }

            // ã‚¹ãƒ©ãƒƒã‚·ãƒ¥/ãƒã‚¤ãƒ•ãƒ³åŒºåˆ‡ã‚Š: YYYY/MM/DD
            const slashMatch = normalized.match(/(\d{4})[\/\-](\d{1,2})[\/\-](\d{1,2})/);
            if (slashMatch) {
                return makeJSTDate(
                    parseInt(slashMatch[1], 10),
                    parseInt(slashMatch[2], 10),
                    parseInt(slashMatch[3], 10)
                );
            }

            // æœˆæ—¥ã®ã¿: MMæœˆDDæ—¥ï¼ˆå¹´ã¯ç¾åœ¨å¹´ã§æ¨å®šï¼‰
            const monthDayMatch = normalized.match(/(\d{1,2})\s*æœˆ\s*(\d{1,2})\s*æ—¥/);
            if (monthDayMatch) {
                let year = baseDate.getFullYear();
                const month = parseInt(monthDayMatch[1], 10);
                const day = parseInt(monthDayMatch[2], 10);
                
                const testDate = makeJSTDate(year, month, day);
                if (testDate && testDate > baseDate) {
                    const timeDiff = testDate.getTime() - baseDate.getTime();
                    if (timeDiff > 30 * 24 * 60 * 60 * 1000) {
                        year--;
                    }
                }
                
                return makeJSTDate(year, month, day);
            }

            return null;
        }

        // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒãƒãƒ³ã‚°é–¢æ•°
        function matchKeywordsInText(rawText) {
            const text = toHalfWidth(rawText.toLowerCase());
            const found = new Set();
            
            for (const kw of FIXED_KEYWORDS) {
                const normalizedKw = toHalfWidth(kw.toLowerCase());
                
                if (normalizedKw === 'oc') {
                    if (/(^|[^a-z0-9])oc([^a-z0-9]|$)/.test(text)) {
                        found.add('OC');
                    }
                } else if (text.includes(normalizedKw)) {
                    found.add(kw);
                }
            }
            
            return Array.from(found);
        }

        // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°æ©Ÿèƒ½
        function debugLog(message) {
            const debugDiv = document.getElementById('debugInfo');
            const timestamp = new Date().toLocaleTimeString();
            const currentLog = debugDiv.textContent;
            debugDiv.textContent = `[${timestamp}] ${message}\n${currentLog}`;
            console.log(`[DEBUG] ${message}`);
        }

        // UIåˆ¶å¾¡é–¢æ•°
        function toggleWarning() {
            const warningSection = document.getElementById('warningSection');
            const warningContent = document.getElementById('warningContent');
            
            warningSection.classList.toggle('active');
            warningContent.classList.toggle('active');
        }

        function initializeKeywords() {
            const keywordDisplay = document.getElementById('keywordDisplay');
            keywordDisplay.innerHTML = '';
            
            FIXED_KEYWORDS.forEach(keyword => {
                const span = document.createElement('span');
                span.className = 'fixed-keyword-tag';
                span.textContent = keyword;
                keywordDisplay.appendChild(span);
            });
            
            debugLog(`å›ºå®šã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ ${FIXED_KEYWORDS.length} å€‹ã‚’è¨­å®šå®Œäº†`);
        }

        // â˜…ä¿®æ­£: ã‚µã‚¤ãƒˆè¿½åŠ æ™‚ã«è‡ªå‹•ä¿å­˜
        function addSite() {
            const urlInput = document.getElementById('siteInput');
            const nameInput = document.getElementById('siteNameInput');
            const url = urlInput.value.trim();
            const customName = nameInput.value.trim();
            
            if (!url) {
                showStatus('URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }

            try {
                new URL(url);
            } catch (e) {
                showStatus('æœ‰åŠ¹ãªURLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
                return;
            }

            if (sites.some(site => site.url === url)) {
                showStatus('ã“ã®ã‚µã‚¤ãƒˆã¯æ—¢ã«è¿½åŠ ã•ã‚Œã¦ã„ã¾ã™', 'error');
                return;
            }

            const siteName = customName || new URL(url).hostname;
            const newSite = { 
                url, 
                name: siteName,
                addedDate: new Date().toISOString()
            };
            
            sites.push(newSite);
            addSiteToList(newSite);
            saveSitesToStorage(); // â˜…è‡ªå‹•ä¿å­˜
            
            urlInput.value = '';
            nameInput.value = '';
            showStatus('ã‚µã‚¤ãƒˆã‚’è¿½åŠ ã—ã€è‡ªå‹•ä¿å­˜ã—ã¾ã—ãŸ', 'success');
            debugLog(`ã‚µã‚¤ãƒˆè¿½åŠ : ${url} (${siteName})`);
        }

        function addSiteToList(site) {
            const siteList = document.getElementById('siteList');
            const div = document.createElement('div');
            div.className = 'list-item';
            div.innerHTML = `
                <div class="site-info">
                    <span class="site-url">${site.url}</span>
                    <span class="site-name">${site.name}</span>
                </div>
                <button class="btn btn-danger" onclick="removeSite(this)">å‰Šé™¤</button>
            `;
            siteList.appendChild(div);
        }

        // â˜…ä¿®æ­£: ã‚µã‚¤ãƒˆå‰Šé™¤æ™‚ã«è‡ªå‹•ä¿å­˜
        function removeSite(button) {
            const listItem = button.parentElement;
            const url = listItem.querySelector('.site-url').textContent;
            sites = sites.filter(site => site.url !== url);
            listItem.remove();
            saveSitesToStorage(); // â˜…è‡ªå‹•ä¿å­˜
            showStatus('ã‚µã‚¤ãƒˆã‚’å‰Šé™¤ã—ã€è‡ªå‹•ä¿å­˜ã—ã¾ã—ãŸ', 'success');
            debugLog(`ã‚µã‚¤ãƒˆå‰Šé™¤: ${url}`);
        }

        function showStatus(message, type) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
            setTimeout(() => statusDiv.innerHTML = '', 5000);
        }

        // ãƒ¡ã‚¤ãƒ³ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°é–¢æ•°
        async function startScraping() {
            const resultsDiv = document.getElementById('results');
            const scrapeBtn = document.getElementById('scrapeBtn');
            const dayRange = parseInt(document.getElementById('dayRange').value) || 7;
            const includeUndated = document.getElementById('includeUndated').checked;
            const showConfidence = document.getElementById('showConfidence').checked;
            const showUrlDebug = document.getElementById('showUrlDebug').checked;
            
            debugLog('ğŸš€ æ°¸ç¶šåŒ–å¯¾å¿œç‰ˆã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°é–‹å§‹');
            debugLog(`è¨­å®š - æœŸé–“: ${dayRange}æ—¥, æ—¥ä»˜ä¸æ˜å«ã‚€: ${includeUndated}, ä¿¡é ¼åº¦è¡¨ç¤º: ${showConfidence}`);
            
            if (sites.length === 0) {
                showStatus('ç›£è¦–ã‚µã‚¤ãƒˆã‚’è¿½åŠ ã—ã¦ãã ã•ã„', 'error');
                return;
            }

            scrapeBtn.disabled = true;
            resultsDiv.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>æ°¸ç¶šåŒ–å¯¾å¿œç‰ˆã§ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ä¸­...</p>
                </div>
            `;

            try {
                const results = await performHighPrecisionScraping(dayRange, includeUndated, showUrlDebug);
                displayResults(results, dayRange, showConfidence, showUrlDebug);
                
                if (results.length === 0 && confirm('çµæœãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤ºã—ã¾ã™ã‹ï¼Ÿ')) {
                    const testResults = generateTestData(dayRange, showConfidence, showUrlDebug);
                    displayResults(testResults, dayRange, showConfidence, showUrlDebug);
                }
                
            } catch (error) {
                console.error('ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ã‚¨ãƒ©ãƒ¼:', error);
                debugLog(`âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                showStatus(`ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`, 'error');
                resultsDiv.innerHTML = `
                    <div class="no-results">
                        <h4>ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</h4>
                        <p>${error.message}</p>
                    </div>
                `;
            } finally {
                scrapeBtn.disabled = false;
            }
        }

        async function performHighPrecisionScraping(dayRange, includeUndated, showUrlDebug) {
            const results = [];
            const cutoffDate = new Date(Date.now() - dayRange * 24 * 60 * 60 * 1000);
            
            for (let i = 0; i < sites.length; i++) {
                const site = sites[i];
                debugLog(`[${i+1}/${sites.length}] ğŸŒ ${site.name} ã‚’å‡¦ç†ä¸­...`);
                showStatus(`${site.name} ã‚’ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ä¸­...`, 'warning');
                
                try {
                    const proxyUrl = 'https://api.allorigins.win/get?url=' + encodeURIComponent(site.url);
                    const response = await fetch(proxyUrl);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    const htmlContent = data.contents;
                    
                    if (!htmlContent) {
                        throw new Error('HTMLã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒç©ºã§ã™');
                    }
                    
                    debugLog(`âœ… HTMLå–å¾—æˆåŠŸ: ${htmlContent.length}æ–‡å­—`);
                    
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(htmlContent, 'text/html');
                    const bodyText = doc.body ? (doc.body.innerText || doc.body.textContent || '') : '';
                    
                    const foundKeywords = matchKeywordsInText(bodyText);
                    
                    if (foundKeywords.length > 0) {
                        debugLog(`ğŸ¯ ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ç™ºè¦‹: ${foundKeywords.join(', ')}`);
                        
                        const selectors = [
                            'article', '.article', '.news-item', '.post', '.entry',
                            '.list-item', 'li', 'tr', '.item', '.box', '.card'
                        ];
                        
                        let foundContent = false;
                        
                        for (const selector of selectors) {
                            const elements = doc.querySelectorAll(selector);
                            
                            if (elements.length > 0) {
                                debugLog(`ğŸ” "${selector}" ã§ ${elements.length} å€‹ã®è¦ç´ ã‚’ç™ºè¦‹`);
                                
                                elements.forEach((element, index) => {
                                    if (index > 30) return;
                                    
                                    const elementText = element.innerText || element.textContent || '';
                                    const elementKeywords = matchKeywordsInText(elementText);
                                    
                                    if (elementKeywords.length > 0) {
                                        const dateResult = extractDateWithHighPrecision(element, doc);
                                        
                                        let shouldInclude = false;
                                        let dateInfo = null;
                                        
                                        if (dateResult) {
                                            const { date, confidence, source } = dateResult;
                                            if (date >= cutoffDate && date <= new Date()) {
                                                shouldInclude = true;
                                                dateInfo = { date, confidence, source };
                                            }
                                        } else if (includeUndated) {
                                            shouldInclude = true;
                                            dateInfo = {
                                                date: new Date(),
                                                confidence: 'unknown',
                                                source: 'æ—¥ä»˜ä¸æ˜'
                                            };
                                        }
                                        
                                        if (shouldInclude) {
                                            const title = extractTitle(element, elementText);
                                            const url = extractUrl(element, site.url);
                                            
                                            const isDuplicate = results.some(r => 
                                                r.url === url && r.title.trim() === title.trim()
                                            );
                                            
                                            if (!isDuplicate) {
                                                foundContent = true;
                                                const resultItem = {
                                                    url: url,
                                                    title: title || `ã€Œ${elementKeywords.join('ã€')}ã€ã‚’å«ã‚€æ¡ˆä»¶`,
                                                    keywords: elementKeywords,
                                                    dateInfo: dateInfo,
                                                    siteName: site.name,
                                                    content: elementText.substring(0, 200).trim(),
                                                    isNew: true
                                                };
                                                
                                                if (showUrlDebug) {
                                                    resultItem.urlDebugInfo = `å…ƒã‚µã‚¤ãƒˆ: ${site.url} â†’ å¤‰æ›çµæœ: ${url}`;
                                                }
                                                
                                                results.push(resultItem);
                                                debugLog(`âœ… çµæœè¿½åŠ : ${title?.substring(0, 50) || 'ç„¡é¡Œ'}...`);
                                            }
                                        }
                                    }
                                });
                                
                                if (foundContent) break;
                            }
                        }
                        
                        if (!foundContent) {
                            debugLog('ğŸ“„ æ§‹é€ åŒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒè¦‹ã¤ã‹ã‚‰ãªã„ãŸã‚ã€ãƒšãƒ¼ã‚¸å…¨ä½“ã‚’è©•ä¾¡');
                            const pageDate = extractDateWithHighPrecision(doc.body, doc);
                            
                            if ((pageDate && pageDate.date >= cutoffDate) || includeUndated) {
                                const pageTitle = doc.title || `${site.name}ã®ãƒšãƒ¼ã‚¸`;
                                const resultItem = {
                                    url: site.url,
                                    title: `${pageTitle}ï¼ˆã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰: ${foundKeywords.join('ã€')}ï¼‰`,
                                    keywords: foundKeywords,
                                    dateInfo: pageDate || {
                                        date: new Date(),
                                        confidence: 'unknown',
                                        source: 'æ—¥ä»˜ä¸æ˜'
                                    },
                                    siteName: site.name,
                                    content: bodyText.substring(0, 200).trim(),
                                    isNew: true
                                };
                                
                                if (showUrlDebug) {
                                    resultItem.urlDebugInfo = `ãƒšãƒ¼ã‚¸å…¨ä½“: ${site.url}`;
                                }
                                
                                results.push(resultItem);
                                debugLog(`âœ… ãƒšãƒ¼ã‚¸å…¨ä½“ã‚’è¿½åŠ : ${pageTitle}`);
                            }
                        }
                    } else {
                        debugLog('âŒ ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒå«ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
                    }
                    
                } catch (error) {
                    console.error(`${site.name} ã§ã‚¨ãƒ©ãƒ¼:`, error);
                    debugLog(`âŒ ${site.name} ã§ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                }
                
                await new Promise(resolve => setTimeout(resolve, 1000));
            }
            
            debugLog(`ğŸ‰ ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°å®Œäº†: ${results.length}ä»¶`);
            return results;
        }

        function extractTitle(element, text) {
            const titleElement = element.querySelector('h1, h2, h3, h4, h5, h6, .title, [class*="title"], strong, b');
            if (titleElement) {
                return titleElement.innerText || titleElement.textContent || '';
            }
            
            if (element.tagName === 'A') {
                return element.innerText || element.textContent || '';
            }
            
            return text.substring(0, 100);
        }

        function extractUrl(element, siteUrl) {
            const linkElement = element.tagName === 'A' ? element : element.querySelector('a');
            
            if (linkElement) {
                const rawHref = linkElement.getAttribute('href');
                
                if (rawHref) {
                    try {
                        const origin = new URL(siteUrl).origin;
                        const resolvedUrl = new URL(rawHref, origin).href;
                        return resolvedUrl;
                    } catch (e) {
                        debugLog(`âŒ URLè§£æ±ºã‚¨ãƒ©ãƒ¼: ${e.message}`);
                        return siteUrl;
                    }
                }
            }
            
            return siteUrl;
        }

        function displayResults(results, dayRange, showConfidence, showUrlDebug) {
            const resultsDiv = document.getElementById('results');
            
            if (results.length === 0) {
                const cutoffDate = new Date(Date.now() - dayRange * 24 * 60 * 60 * 1000);
                const dateRange = `${cutoffDate.toLocaleDateString('ja-JP')} ï½ ${new Date().toLocaleDateString('ja-JP')}`;
                
                resultsDiv.innerHTML = `
                    <div class="no-results">
                        <h4>è©²å½“æ¡ˆä»¶ãªã—</h4>
                        <p><strong>æ¤œç´¢æœŸé–“:</strong> ${dateRange}ï¼ˆéå»${dayRange}æ—¥é–“ï¼‰</p>
                        <p><strong>ç›£è¦–ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰:</strong> ${keywords.join('ã€')}</p>
                        <p><strong>ç›£è¦–ã‚µã‚¤ãƒˆ:</strong> ${sites.map(site => site.name).join('ã€')}</p>
                        <p>æŒ‡å®šã•ã‚ŒãŸæœŸé–“å†…ã«è©²å½“ã™ã‚‹ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å«ã‚€è¨˜äº‹ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</p>
                    </div>
                `;
                showStatus('è©²å½“ã™ã‚‹æ¡ˆä»¶ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ', 'warning');
                return;
            }

            // çµæœã‚’æ—¥ä»˜é †ã§ã‚½ãƒ¼ãƒˆ
            results.sort((a, b) => new Date(b.dateInfo.date) - new Date(a.dateInfo.date));

            const cutoffDate = new Date(Date.now() - dayRange * 24 * 60 * 60 * 1000);
            const dateRange = `${cutoffDate.toLocaleDateString('ja-JP')} ï½ ${new Date().toLocaleDateString('ja-JP')}`;
            
            let resultsHTML = `
                <h4>ğŸ—ï¸ ${results.length}ä»¶ã®å»ºç¯‰è¨­å‚™é–¢é€£æ¡ˆä»¶ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ</h4>
                <p style="color: #666; font-size: 0.9rem; margin-bottom: 15px;">
                    <strong>æ¤œç´¢æœŸé–“:</strong> ${dateRange}ï¼ˆéå»${dayRange}æ—¥é–“ï¼‰
                </p>
            `;
            
            results.forEach(result => {
                const publishedDate = new Date(result.dateInfo.date);
                const today = new Date();
                const diffTime = Math.abs(today - publishedDate);
                const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                
                const dateDisplay = publishedDate.toLocaleDateString('ja-JP', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    weekday: 'short'
                });
                
                // æ–°ç€ãƒ©ãƒ™ãƒ«
                let newLabel = '';
                if (diffDays === 0) {
                    newLabel = '<span style="background: #ff4444; color: white; padding: 2px 6px; border-radius: 3px; font-size: 0.8rem; margin-left: 8px;">æœ¬æ—¥</span>';
                } else if (diffDays === 1) {
                    newLabel = '<span style="background: #ff8800; color: white; padding: 2px 6px; border-radius: 3px; font-size: 0.8rem; margin-left: 8px;">æ˜¨æ—¥</span>';
                } else if (diffDays <= 3) {
                    newLabel = '<span style="background: #4CAF50; color: white; padding: 2px 6px; border-radius: 3px; font-size: 0.8rem; margin-left: 8px;">æ–°ç€</span>';
                }
                
                // ä¿¡é ¼åº¦ãƒãƒƒã‚¸
                let confidenceBadge = '';
                if (showConfidence) {
                    const confidenceText = {
                        'high': 'é«˜',
                        'medium': 'ä¸­',
                        'low': 'ä½',
                        'unknown': 'ä¸æ˜'
                    }[result.dateInfo.confidence];
                    
                    confidenceBadge = `<span class="confidence-badge confidence-${result.dateInfo.confidence}" title="${result.dateInfo.source}">ä¿¡é ¼åº¦: ${confidenceText}</span>`;
                }
                
                // URL ãƒ‡ãƒãƒƒã‚°æƒ…å ±
                let urlDebugInfo = '';
                if (showUrlDebug && result.urlDebugInfo) {
                    urlDebugInfo = `<div class="url-debug">ğŸ”— ${result.urlDebugInfo}</div>`;
                }
                
                const keywordList = result.keywords.join(', ');
                const itemClass = result.dateInfo.confidence === 'low' || result.dateInfo.confidence === 'unknown' ? 'result-item low-confidence' : 'result-item';
                
                resultsHTML += `
                    <div class="${itemClass}">
                        <div>
                            <a href="${result.url}" class="result-url" target="_blank" rel="noopener noreferrer">${result.url}</a>
                        </div>
                        ${urlDebugInfo}
                        <div style="margin-top: 8px; font-weight: 600; color: #333; display: flex; align-items: center; flex-wrap: wrap;">
                            ${result.title}${newLabel}${confidenceBadge}
                        </div>
                        ${result.content ? `<div style="margin-top: 5px; color: #555; font-size: 0.9rem;">${result.content.substring(0, 200)}${result.content.length > 200 ? '...' : ''}</div>` : ''}
                        <div class="result-keywords">
                            ${dateDisplay} | ã‚µã‚¤ãƒˆ: ${result.siteName} | è©²å½“ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰: ${keywordList}
                            ${showConfidence ? ` | æŠ½å‡ºã‚½ãƒ¼ã‚¹: ${result.dateInfo.source}` : ''}
                        </div>
                    </div>
                `;
            });

            resultsDiv.innerHTML = resultsHTML;
            showStatus(`${results.length}ä»¶ã®æ¡ˆä»¶ã‚’ç™ºè¦‹ã—ã¾ã—ãŸ`, 'success');
            debugLog(`ğŸ“Š çµæœè¡¨ç¤ºå®Œäº†: ${results.length}ä»¶`);
        }

        function generateTestData(dayRange, showConfidence, showUrlDebug) {
            debugLog('ğŸ§ª ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ç”Ÿæˆä¸­...');
            const testResults = [];
            const today = new Date();
            
            const testData = [
                {
                    title: 'èˆ¹æ©‹å¸‚ ãƒšãƒƒãƒˆãƒœãƒˆãƒ«å£²æ‰•å˜ä¾¡å¥‘ç´„ã«ä¿‚ã‚‹æŒ‡åç«¶äº‰å…¥æœ­çµæœ',
                    keywords: ['ç«¶äº‰', 'å…¥æœ­'],
                    confidence: 'high',
                    source: 'JSON-LD:datePublished',
                    daysAgo: 2,
                    url: 'https://www.city.funabashi.lg.jp/jigyou/nyusatsu/002/p140434.html'
                },
                {
                    title: 'å°å­¦æ ¡ å±‹ä¸Šé˜²æ°´å·¥äº‹ ä¸€èˆ¬ç«¶äº‰å…¥æœ­',
                    keywords: ['ç«¶äº‰', 'é˜²æ°´', 'å±‹ä¸Š'],
                    confidence: 'medium',
                    source: 'HTML:.date',
                    daysAgo: 5,
                    url: 'https://example-city.gov.jp/tender/waterproof-2024-001.html'
                },
                {
                    title: 'å…¬æ°‘é¤¨ å†…è£…æ”¹è£…å·¥äº‹ ã‚ªãƒ¼ãƒ—ãƒ³ã‚«ã‚¦ãƒ³ã‚¿æ–¹å¼',
                    keywords: ['ã‚ªãƒ¼ãƒ—ãƒ³ã‚«ã‚¦ãƒ³ã‚¿', 'å†…è£…', 'æ”¹è£…'],
                    confidence: 'high',
                    source: 'ãƒ¡ã‚¿:article:published_time',
                    daysAgo: 1,
                    url: 'https://example-city.gov.jp/tender/interior-renovation-2024.html'
                }
            ];
            
            testData.forEach((item, i) => {
                const testDate = new Date(today.getTime() - item.daysAgo * 24 * 60 * 60 * 1000);
                
                const resultItem = {
                    url: item.url,
                    title: item.title,
                    keywords: item.keywords,
                    dateInfo: {
                        date: testDate,
                        confidence: item.confidence,
                        source: item.source
                    },
                    siteName: 'ãƒ†ã‚¹ãƒˆè‡ªæ²»ä½“ã‚µã‚¤ãƒˆ',
                    content: 'ã“ã‚Œã¯æ°¸ç¶šåŒ–å¯¾å¿œç‰ˆã®ãƒ†ã‚¹ãƒˆç”¨æ¨¡æ“¬ãƒ‡ãƒ¼ã‚¿ã§ã™ã€‚',
                    isNew: true
                };
                
                if (showUrlDebug) {
                    resultItem.urlDebugInfo = `ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿: æ­£ã—ã„URLç”Ÿæˆç¢ºèªæ¸ˆã¿`;
                }
                
                testResults.push(resultItem);
            });
            
            debugLog(`âœ… ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ç”Ÿæˆå®Œäº†: ${testResults.length}ä»¶`);
            return testResults;
        }

        // â˜…åˆæœŸåŒ–å‡¦ç†ã«æ°¸ç¶šåŒ–æ©Ÿèƒ½ã‚’è¿½åŠ 
        document.addEventListener('DOMContentLoaded', function() {
            debugLog('ğŸš€ æ°¸ç¶šåŒ–å¯¾å¿œç‰ˆã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–é–‹å§‹');
            
            // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰è¡¨ç¤ºåˆæœŸåŒ–
            initializeKeywords();
            
            // â˜…ä¿å­˜ã•ã‚ŒãŸã‚µã‚¤ãƒˆæƒ…å ±ã‚’å¾©å…ƒ
            const savedSites = loadSitesFromStorage();
            if (savedSites.length > 0) {
                sites = savedSites;
                refreshSiteList();
                debugLog(`ğŸ’¾ ${savedSites.length}ä»¶ã®ã‚µã‚¤ãƒˆæƒ…å ±ã‚’å¾©å…ƒã—ã¾ã—ãŸ`);
                showStatus(`${savedSites.length}ä»¶ã®ã‚µã‚¤ãƒˆæƒ…å ±ã‚’å¾©å…ƒã—ã¾ã—ãŸ`, 'success');
            } else {
                debugLog('ğŸ“ ä¿å­˜ã•ã‚ŒãŸã‚µã‚¤ãƒˆæƒ…å ±ãªã—ï¼ˆåˆå›èµ·å‹•ï¼‰');
            }
            
            // ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸æƒ…å ±ã‚’æ›´æ–°
            updateStorageInfo();
            
            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
            document.getElementById('siteInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') addSite();
            });

            document.getElementById('siteNameInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') addSite();
            });

            showStatus('v5.2 æ°¸ç¶šåŒ–å¯¾å¿œç‰ˆã‚·ã‚¹ãƒ†ãƒ ãŒæº–å‚™ã§ãã¾ã—ãŸ', 'success');
            debugLog('âœ… åˆæœŸåŒ–å®Œäº† - æ°¸ç¶šåŒ–æ©Ÿèƒ½æœ‰åŠ¹');
        });
    </script>
</body>
</html>
