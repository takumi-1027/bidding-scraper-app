<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>建築設備入札スクレイピングシステム v5.0 - 高精度日付版</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(45deg, #2196F3, #21CBF3);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .main-content {
            padding: 30px;
        }

        .section {
            margin-bottom: 30px;
            padding: 25px;
            border-radius: 10px;
            background: #f8f9fa;
            border-left: 4px solid #2196F3;
        }

        .section h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }

        .debug-section {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            margin-bottom: 20px;
            padding: 15px;
        }

        .debug-section h3 {
            color: #856404;
            margin-bottom: 10px;
        }

        .debug-info {
            font-family: monospace;
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }

        .warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            margin-bottom: 20px;
            color: #856404;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .warning-header {
            padding: 15px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #ffeaa7;
            transition: background-color 0.3s ease;
        }

        .warning-header:hover {
            background: #ffd93d;
        }

        .warning-header h4 {
            margin: 0;
            color: #b45309;
        }

        .warning-toggle {
            font-size: 1.2rem;
            font-weight: bold;
            color: #b45309;
            transition: transform 0.3s ease;
        }

        .warning-content {
            padding: 0 15px;
            max-height: 0;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .warning-content.active {
            padding: 15px;
            max-height: 500px;
        }

        .warning.active .warning-toggle {
            transform: rotate(180deg);
        }

        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .input-group input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
            min-width: 200px;
        }

        .input-group input:focus {
            outline: none;
            border-color: #2196F3;
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: linear-gradient(45deg, #2196F3, #21CBF3);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(33, 150, 243, 0.4);
        }

        .btn-danger {
            background: linear-gradient(45deg, #f44336, #ff6b6b);
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(244, 67, 54, 0.4);
        }

        .btn-success {
            background: linear-gradient(45deg, #4CAF50, #66BB6A);
            color: white;
            font-size: 16px;
            padding: 15px 30px;
            margin: 20px 0;
            width: 100%;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(76, 175, 80, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: white;
            border-radius: 8px;
            margin-bottom: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .list-item:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.15);
        }

        .list-item .site-info {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1;
            margin-right: 10px;
        }

        .list-item .site-url {
            word-break: break-all;
        }

        .list-item .site-name {
            color: #666;
            font-style: italic;
            font-size: 0.9rem;
        }

        .keyword-info {
            background: #e8f5e9;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #4CAF50;
        }

        .keyword-info h4 {
            color: #2e7d32;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .keyword-info p {
            color: #388e3c;
            line-height: 1.6;
        }

        .keyword-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border: 2px solid #e9ecef;
        }

        .fixed-keyword-tag {
            display: inline-flex;
            align-items: center;
            background: #e3f2fd;
            color: #1976d2;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            border: 1px solid #bbdefb;
            font-weight: 600;
        }

        .date-settings {
            background: #e8f4fd;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #2196F3;
        }

        .date-settings h4 {
            color: #1976d2;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .date-settings label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .date-settings input[type="checkbox"] {
            margin-right: 8px;
        }

        .results {
            background: #fff;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .results h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }

        .result-item {
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            border-left: 4px solid #4CAF50;
            background: #f1f8e9;
            transition: all 0.3s ease;
        }

        .result-item:hover {
            background: #e8f5e8;
            transform: translateY(-2px);
        }

        .result-item.low-confidence {
            border-left-color: #ff9800;
            background: #fff3e0;
        }

        .result-url {
            color: #2196F3;
            text-decoration: none;
            font-weight: 600;
            word-break: break-all;
        }

        .result-url:hover {
            text-decoration: underline;
        }

        .result-keywords {
            color: #666;
            font-size: 0.9rem;
            margin-top: 5px;
        }

        .confidence-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 8px;
        }

        .confidence-high {
            background: #4CAF50;
            color: white;
        }

        .confidence-medium {
            background: #ff9800;
            color: white;
        }

        .confidence-low {
            background: #f44336;
            color: white;
        }

        .no-results {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 30px;
            background: #f5f5f5;
            border-radius: 8px;
        }

        .loading {
            text-align: center;
            padding: 20px;
        }

        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #2196F3;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: 600;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        @media (max-width: 768px) {
            .input-group {
                flex-direction: column;
            }
            
            .input-group input {
                min-width: 100%;
            }
            
            .list-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .keyword-container {
                gap: 8px;
            }

            .fixed-keyword-tag {
                font-size: 12px;
                padding: 6px 12px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>建築設備入札スクレイピングシステム v5.0</h1>
            <p>高精度日付抽出版 - 建築・設備・修繕関連の入札・公告情報専用収集システム</p>
        </div>

        <div class="main-content">
            <!-- デバッグ情報セクション -->
            <div class="debug-section">
                <h3>🔍 日付抽出デバッグ情報</h3>
                <div id="debugInfo" class="debug-info">システム起動中...</div>
            </div>

            <!-- 重要な注意事項 -->
            <div class="warning" id="warningSection">
                <div class="warning-header" onclick="toggleWarning()">
                    <h4>⚠️ v5.0 高精度日付抽出の改善点</h4>
                    <span class="warning-toggle">▼</span>
                </div>
                <div class="warning-content" id="warningContent">
                    <ul>
                        <li><strong>日付不明記事の除外:</strong> 日付が特定できない記事は結果から完全除外</li>
                        <li><strong>多段階抽出システム:</strong> 構造化データ → メタデータ → パターンマッチングの優先順位</li>
                        <li><strong>和暦・相対日付対応:</strong> 令和表記、「昨日」「一昨日」「○日前」に対応</li>
                        <li><strong>信頼度システム:</strong> 抽出した日付の信頼度を3段階で表示</li>
                        <li><strong>JST対応:</strong> 日本標準時での正確な期間判定</li>
                    </ul>
                </div>
            </div>

            <!-- サイト管理セクション -->
            <div class="section">
                <h2>監視サイト管理</h2>
                <div class="input-group">
                    <input type="url" id="siteInput" placeholder="監視するサイトのURLを入力（例：https://www.city.example.jp/）" />
                    <input type="text" id="siteNameInput" placeholder="サイト名（任意）" />
                    <button class="btn btn-primary" onclick="addSite()">サイト追加</button>
                </div>
                <div id="siteList"></div>
            </div>

            <!-- 固定キーワード表示セクション -->
            <div class="section">
                <h2>監視キーワード（固定設定）</h2>
                <div class="keyword-info">
                    <h4>🏗️ 建築・設備・修繕関連キーワード</h4>
                    <p>以下の29個のキーワードが自動的に設定され、これらを含む情報をスクレイピングします。</p>
                </div>
                <div class="keyword-container" id="keywordDisplay"></div>
            </div>

            <!-- プロキシ設定セクション -->
            <div class="section">
                <h2>プロキシ設定</h2>
                <div class="input-group">
                    <input type="text" id="proxyUrl" placeholder="プロキシサーバーURL" value="https://api.allorigins.win/get" />
                    <input type="text" id="apiKey" placeholder="APIキー（必要な場合）" />
                </div>
            </div>

            <!-- スクレイピング実行セクション -->
            <div class="section">
                <h2>スクレイピング実行</h2>
                <div class="date-settings">
                    <h4>📅 日付抽出設定</h4>
                    <div class="input-group">
                        <label>検索期間: </label>
                        <input type="number" id="dayRange" placeholder="過去何日間" value="7" min="1" max="30" />
                        <span>日間</span>
                    </div>
                    <label>
                        <input type="checkbox" id="includeUndated" />
                        日付不明の記事も含める（精度は低下します）
                    </label>
                    <label>
                        <input type="checkbox" id="showConfidence" checked />
                        日付信頼度を表示する
                    </label>
                </div>
                <button class="btn btn-success" id="scrapeBtn" onclick="startScraping()">
                    高精度スクレイピング開始
                </button>
                <div id="statusMessage"></div>
            </div>

            <!-- 結果表示セクション -->
            <div class="results">
                <h3>スクレイピング結果</h3>
                <div id="results">
                    <div class="no-results">スクレイピングを実行してください</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 固定キーワードリスト
        const FIXED_KEYWORDS = [
            '入札', '公告', '競争', 'オープンカウンタ', 'OC',
            '改修', '改装', '工事', '防水', '塗装', '壁', '建物',
            '屋上', '屋根', '作業', '修繕', '補修', '建築', '床',
            'トイレ', '照明', '設備', '空調', '内装', '雨漏り',
            '漏水', '水漏れ', '復旧', '便器'
        ];

        // グローバル変数
        let sites = [];
        let keywords = [...FIXED_KEYWORDS];

        // 日付ユーティリティ関数
        function toHalfWidth(str) {
            if (!str) return '';
            return str.replace(/[Ａ-Ｚａ-ｚ０-９]/g, ch => 
                String.fromCharCode(ch.charCodeAt(0) - 0xFEE0)
            ).replace(/[－―ー–]/g, '-').replace(/[／]/g, '/');
        }

        function makeJSTDate(year, month, day, hour = 0, minute = 0, second = 0) {
            try {
                const date = new Date(year, month - 1, day, hour, minute, second);
                return isNaN(date.getTime()) ? null : date;
            } catch (e) {
                return null;
            }
        }

        function eraToWesternYear(era, year) {
            const eraMap = {
                '令和': 2018,
                '平成': 1988,
                '昭和': 1925,
                '大正': 1911
            };
            
            if (!(era in eraMap)) return null;
            const yearNum = (year === '元') ? 1 : parseInt(year, 10);
            return eraMap[era] + yearNum;
        }

        // 高精度日付抽出システム
        function extractDateWithHighPrecision(element, doc, baseDate = new Date()) {
            debugLog(`🔍 高精度日付抽出開始: ${element.textContent?.substring(0, 50) || 'N/A'}...`);
            
            const candidates = [];
            
            // 1. JSON-LD構造化データ（最高精度）
            try {
                const jsonScripts = doc.querySelectorAll('script[type="application/ld+json"]');
                for (const script of jsonScripts) {
                    const data = JSON.parse(script.textContent);
                    const dateFields = ['datePublished', 'dateCreated', 'uploadDate', 'dateModified'];
                    
                    function extractFromJson(obj) {
                        if (!obj || typeof obj !== 'object') return;
                        
                        for (const field of dateFields) {
                            if (obj[field]) {
                                const date = parseAdvancedDate(obj[field], baseDate);
                                if (date) {
                                    candidates.push({
                                        date: date,
                                        confidence: 'high',
                                        source: `JSON-LD:${field}`
                                    });
                                }
                            }
                        }
                        
                        if (Array.isArray(obj)) {
                            obj.forEach(extractFromJson);
                        } else {
                            Object.values(obj).forEach(extractFromJson);
                        }
                    }
                    
                    extractFromJson(data);
                }
            } catch (e) {
                debugLog(`JSON-LD解析エラー: ${e.message}`);
            }

            // 2. メタデータ（高精度）
            const metaSelectors = [
                'meta[property="article:published_time"]',
                'meta[property="article:modified_time"]',
                'meta[name="publication-date"]',
                'meta[name="date"]',
                'meta[property="og:updated_time"]'
            ];
            
            for (const selector of metaSelectors) {
                const meta = doc.querySelector(selector);
                if (meta) {
                    const content = meta.getAttribute('content');
                    const date = parseAdvancedDate(content, baseDate);
                    if (date) {
                        candidates.push({
                            date: date,
                            confidence: 'high',
                            source: `メタ:${selector.split('[')[1]?.split(']')[0]}`
                        });
                    }
                }
            }

            // 3. HTML構造化要素（中精度）
            const dateSelectors = [
                'time[datetime]',
                '.date', '.datetime', '.published', '.post-date',
                '[class*="date"]', '[class*="time"]'
            ];
            
            for (const selector of dateSelectors) {
                const elements = element.querySelectorAll(selector);
                elements.forEach(el => {
                    const datetime = el.getAttribute('datetime');
                    const text = el.textContent;
                    
                    if (datetime) {
                        const date = parseAdvancedDate(datetime, baseDate);
                        if (date) {
                            candidates.push({
                                date: date,
                                confidence: 'high',
                                source: `HTML:${selector}[datetime]`
                            });
                        }
                    }
                    
                    if (text) {
                        const date = parseAdvancedDate(text, baseDate);
                        if (date) {
                            candidates.push({
                                date: date,
                                confidence: 'medium',
                                source: `HTML:${selector}`
                            });
                        }
                    }
                });
            }

            // 4. テキストパターンマッチング（低精度）
            const elementText = element.textContent || element.innerText || '';
            const textDate = parseAdvancedDate(elementText, baseDate);
            if (textDate) {
                candidates.push({
                    date: textDate,
                    confidence: 'low',
                    source: 'テキストパターン'
                });
            }

            // 候補から最適なものを選択
            if (candidates.length === 0) {
                debugLog('❌ 日付候補が見つかりませんでした');
                return null;
            }

            // 有効性チェック
            const now = new Date();
            const oneYearAgo = new Date(now.getFullYear() - 1, now.getMonth(), now.getDate());
            const oneWeekFuture = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);
            
            const validCandidates = candidates.filter(c => 
                c.date >= oneYearAgo && c.date <= oneWeekFuture
            );

            if (validCandidates.length === 0) {
                debugLog('❌ 有効な日付候補がありませんでした');
                return null;
            }

            // 信頼度順でソート
            const confidenceOrder = { 'high': 3, 'medium': 2, 'low': 1 };
            validCandidates.sort((a, b) => {
                const confDiff = confidenceOrder[b.confidence] - confidenceOrder[a.confidence];
                return confDiff !== 0 ? confDiff : b.date - a.date;
            });

            const best = validCandidates[0];
            debugLog(`✅ 最適な日付を選択: ${best.date.toISOString()} (信頼度: ${best.confidence}, ソース: ${best.source})`);
            
            return best;
        }

        // 包括的日付パース関数
        function parseAdvancedDate(dateStr, baseDate = new Date()) {
            if (!dateStr || typeof dateStr !== 'string') return null;
            
            const normalized = toHalfWidth(dateStr.trim());
            
            // 相対日付処理
            if (/本日|今日/.test(normalized)) {
                return makeJSTDate(baseDate.getFullYear(), baseDate.getMonth() + 1, baseDate.getDate());
            }
            if (/昨日/.test(normalized)) {
                const yesterday = new Date(baseDate.getTime() - 24 * 60 * 60 * 1000);
                return makeJSTDate(yesterday.getFullYear(), yesterday.getMonth() + 1, yesterday.getDate());
            }
            if (/一昨日/.test(normalized)) {
                const dayBefore = new Date(baseDate.getTime() - 2 * 24 * 60 * 60 * 1000);
                return makeJSTDate(dayBefore.getFullYear(), dayBefore.getMonth() + 1, dayBefore.getDate());
            }
            
            const relativeMatch = normalized.match(/(\d+)\s*日前/);
            if (relativeMatch) {
                const daysAgo = parseInt(relativeMatch[1], 10);
                const targetDate = new Date(baseDate.getTime() - daysAgo * 24 * 60 * 60 * 1000);
                return makeJSTDate(targetDate.getFullYear(), targetDate.getMonth() + 1, targetDate.getDate());
            }

            // ISO形式
            const isoMatch = normalized.match(/(\d{4})-(\d{1,2})-(\d{1,2})(?:T(\d{1,2}):(\d{1,2}):(\d{1,2}))?/);
            if (isoMatch) {
                return makeJSTDate(
                    parseInt(isoMatch[1], 10),
                    parseInt(isoMatch[2], 10),
                    parseInt(isoMatch[3], 10),
                    parseInt(isoMatch[4] || '0', 10),
                    parseInt(isoMatch[5] || '0', 10),
                    parseInt(isoMatch[6] || '0', 10)
                );
            }

            // 日本語表記: YYYY年MM月DD日
            const jpMatch = normalized.match(/(\d{4})\s*年\s*(\d{1,2})\s*月\s*(\d{1,2})\s*日/);
            if (jpMatch) {
                return makeJSTDate(
                    parseInt(jpMatch[1], 10),
                    parseInt(jpMatch[2], 10),
                    parseInt(jpMatch[3], 10)
                );
            }

            // 和暦: 令和X年MM月DD日
            const eraMatch = normalized.match(/(令和|平成|昭和|大正)\s*(元|\d+)\s*年\s*(\d{1,2})\s*月\s*(\d{1,2})\s*日/);
            if (eraMatch) {
                const westernYear = eraToWesternYear(eraMatch[1], eraMatch[2]);
                if (westernYear) {
                    return makeJSTDate(
                        westernYear,
                        parseInt(eraMatch[3], 10),
                        parseInt(eraMatch[4], 10)
                    );
                }
            }

            // 和暦略記: R6.1.5
            const eraShortMatch = normalized.match(/([RrHhSs])(\d+)\.(\d{1,2})\.(\d{1,2})/);
            if (eraShortMatch) {
                const eraMap = { 'R': '令和', 'r': '令和', 'H': '平成', 'h': '平成', 'S': '昭和', 's': '昭和' };
                const era = eraMap[eraShortMatch[1]];
                if (era) {
                    const westernYear = eraToWesternYear(era, eraShortMatch[2]);
                    if (westernYear) {
                        return makeJSTDate(
                            westernYear,
                            parseInt(eraShortMatch[3], 10),
                            parseInt(eraShortMatch[4], 10)
                        );
                    }
                }
            }

            // スラッシュ/ハイフン区切り: YYYY/MM/DD
            const slashMatch = normalized.match(/(\d{4})[\/\-](\d{1,2})[\/\-](\d{1,2})/);
            if (slashMatch) {
                return makeJSTDate(
                    parseInt(slashMatch[1], 10),
                    parseInt(slashMatch[2], 10),
                    parseInt(slashMatch[3], 10)
                );
            }

            // 月日のみ: MM月DD日（年は現在年で推定）
            const monthDayMatch = normalized.match(/(\d{1,2})\s*月\s*(\d{1,2})\s*日/);
            if (monthDayMatch) {
                let year = baseDate.getFullYear();
                const month = parseInt(monthDayMatch[1], 10);
                const day = parseInt(monthDayMatch[2], 10);
                
                const testDate = makeJSTDate(year, month, day);
                if (testDate && testDate > baseDate) {
                    // 未来日付の場合は前年を試す
                    const timeDiff = testDate.getTime() - baseDate.getTime();
                    if (timeDiff > 30 * 24 * 60 * 60 * 1000) { // 30日以上未来
                        year--;
                    }
                }
                
                return makeJSTDate(year, month, day);
            }

            return null;
        }

        // キーワードマッチング関数
        function matchKeywordsInText(rawText) {
            const text = toHalfWidth(rawText.toLowerCase());
            const found = new Set();
            
            for (const kw of FIXED_KEYWORDS) {
                const normalizedKw = toHalfWidth(kw.toLowerCase());
                
                if (normalizedKw === 'oc') {
                    if (/(^|[^a-z0-9])oc([^a-z0-9]|$)/.test(text)) {
                        found.add('OC');
                    }
                } else if (text.includes(normalizedKw)) {
                    found.add(kw);
                }
            }
            
            return Array.from(found);
        }

        // デバッグログ機能
        function debugLog(message) {
            const debugDiv = document.getElementById('debugInfo');
            const timestamp = new Date().toLocaleTimeString();
            const currentLog = debugDiv.textContent;
            debugDiv.textContent = `[${timestamp}] ${message}\n${currentLog}`;
            console.log(`[DEBUG] ${message}`);
        }

        // UI制御関数
        function toggleWarning() {
            const warningSection = document.getElementById('warningSection');
            const warningContent = document.getElementById('warningContent');
            
            warningSection.classList.toggle('active');
            warningContent.classList.toggle('active');
        }

        function initializeKeywords() {
            const keywordDisplay = document.getElementById('keywordDisplay');
            keywordDisplay.innerHTML = '';
            
            FIXED_KEYWORDS.forEach(keyword => {
                const span = document.createElement('span');
                span.className = 'fixed-keyword-tag';
                span.textContent = keyword;
                keywordDisplay.appendChild(span);
            });
            
            debugLog(`固定キーワード ${FIXED_KEYWORDS.length} 個を設定完了`);
        }

        function addSite() {
            const urlInput = document.getElementById('siteInput');
            const nameInput = document.getElementById('siteNameInput');
            const url = urlInput.value.trim();
            const customName = nameInput.value.trim();
            
            if (!url) {
                showStatus('URLを入力してください', 'error');
                return;
            }

            try {
                new URL(url);
            } catch (e) {
                showStatus('有効なURLを入力してください', 'error');
                return;
            }

            if (sites.some(site => site.url === url)) {
                showStatus('このサイトは既に追加されています', 'error');
                return;
            }

            const siteName = customName || new URL(url).hostname;
            const newSite = { url, name: siteName };
            sites.push(newSite);
            addSiteToList(newSite);
            urlInput.value = '';
            nameInput.value = '';
            showStatus('サイトを追加しました', 'success');
            debugLog(`サイト追加: ${url} (${siteName})`);
        }

        function addSiteToList(site) {
            const siteList = document.getElementById('siteList');
            const div = document.createElement('div');
            div.className = 'list-item';
            div.innerHTML = `
                <div class="site-info">
                    <span class="site-url">${site.url}</span>
                    <span class="site-name">${site.name}</span>
                </div>
                <button class="btn btn-danger" onclick="removeSite(this)">削除</button>
            `;
            siteList.appendChild(div);
        }

        function removeSite(button) {
            const listItem = button.parentElement;
            const url = listItem.querySelector('.site-url').textContent;
            sites = sites.filter(site => site.url !== url);
            listItem.remove();
            showStatus('サイトを削除しました', 'success');
            debugLog(`サイト削除: ${url}`);
        }

        function showStatus(message, type) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
            setTimeout(() => statusDiv.innerHTML = '', 5000);
        }

        // メインスクレイピング関数
        async function startScraping() {
            const resultsDiv = document.getElementById('results');
            const scrapeBtn = document.getElementById('scrapeBtn');
            const dayRange = parseInt(document.getElementById('dayRange').value) || 7;
            const includeUndated = document.getElementById('includeUndated').checked;
            const showConfidence = document.getElementById('showConfidence').checked;
            
            debugLog('🚀 高精度日付抽出スクレイピング開始');
            debugLog(`設定 - 期間: ${dayRange}日, 日付不明含む: ${includeUndated}, 信頼度表示: ${showConfidence}`);
            
            if (sites.length === 0) {
                showStatus('監視サイトを追加してください', 'error');
                return;
            }

            scrapeBtn.disabled = true;
            resultsDiv.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>高精度日付抽出でスクレイピング中...</p>
                </div>
            `;

            try {
                const results = await performHighPrecisionScraping(dayRange, includeUndated);
                displayResults(results, dayRange, showConfidence);
                
                if (results.length === 0 && confirm('結果が見つかりませんでした。テストデータを表示しますか？')) {
                    const testResults = generateTestData(dayRange, showConfidence);
                    displayResults(testResults, dayRange, showConfidence);
                }
                
            } catch (error) {
                console.error('スクレイピングエラー:', error);
                debugLog(`❌ エラー: ${error.message}`);
                showStatus(`エラーが発生しました: ${error.message}`, 'error');
                resultsDiv.innerHTML = `
                    <div class="no-results">
                        <h4>エラーが発生しました</h4>
                        <p>${error.message}</p>
                    </div>
                `;
            } finally {
                scrapeBtn.disabled = false;
            }
        }

        async function performHighPrecisionScraping(dayRange, includeUndated) {
            const results = [];
            const cutoffDate = new Date(Date.now() - dayRange * 24 * 60 * 60 * 1000);
            
            for (let i = 0; i < sites.length; i++) {
                const site = sites[i];
                debugLog(`[${i+1}/${sites.length}] 🌐 ${site.name} を処理中...`);
                showStatus(`${site.name} をスクレイピング中...`, 'warning');
                
                try {
                    const proxyUrl = 'https://api.allorigins.win/get?url=' + encodeURIComponent(site.url);
                    const response = await fetch(proxyUrl);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    const htmlContent = data.contents;
                    
                    if (!htmlContent) {
                        throw new Error('HTMLコンテンツが空です');
                    }
                    
                    debugLog(`✅ HTML取得成功: ${htmlContent.length}文字`);
                    
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(htmlContent, 'text/html');
                    const bodyText = doc.body ? (doc.body.innerText || doc.body.textContent || '') : '';
                    
                    const foundKeywords = matchKeywordsInText(bodyText);
                    
                    if (foundKeywords.length > 0) {
                        debugLog(`🎯 キーワード発見: ${foundKeywords.join(', ')}`);
                        
                        const selectors = [
                            'article', '.article', '.news-item', '.post', '.entry',
                            '.list-item', 'li', 'tr', '.item', '.box', '.card'
                        ];
                        
                        let foundContent = false;
                        
                        for (const selector of selectors) {
                            const elements = doc.querySelectorAll(selector);
                            
                            if (elements.length > 0) {
                                debugLog(`🔍 "${selector}" で ${elements.length} 個の要素を発見`);
                                
                                elements.forEach((element, index) => {
                                    if (index > 30) return; // 処理数制限
                                    
                                    const elementText = element.innerText || element.textContent || '';
                                    const elementKeywords = matchKeywordsInText(elementText);
                                    
                                    if (elementKeywords.length > 0) {
                                        const dateResult = extractDateWithHighPrecision(element, doc);
                                        
                                        let shouldInclude = false;
                                        let dateInfo = null;
                                        
                                        if (dateResult) {
                                            const { date, confidence, source } = dateResult;
                                            if (date >= cutoffDate && date <= new Date()) {
                                                shouldInclude = true;
                                                dateInfo = { date, confidence, source };
                                            } else {
                                                debugLog(`📅 期間外のため除外: ${date.toISOString()}`);
                                            }
                                        } else if (includeUndated) {
                                            shouldInclude = true;
                                            dateInfo = {
                                                date: new Date(),
                                                confidence: 'unknown',
                                                source: '日付不明'
                                            };
                                            debugLog('📅 日付不明だが設定により含める');
                                        } else {
                                            debugLog('📅 日付不明のため除外');
                                        }
                                        
                                        if (shouldInclude) {
                                            const title = extractTitle(element, elementText);
                                            const url = extractUrl(element, site.url);
                                            
                                            const isDuplicate = results.some(r => 
                                                r.url === url && r.title.trim() === title.trim()
                                            );
                                            
                                            if (!isDuplicate) {
                                                foundContent = true;
                                                results.push({
                                                    url: url,
                                                    title: title || `「${elementKeywords.join('、')}」を含む案件`,
                                                    keywords: elementKeywords,
                                                    dateInfo: dateInfo,
                                                    siteName: site.name,
                                                    content: elementText.substring(0, 200).trim(),
                                                    isNew: true
                                                });
                                                
                                                debugLog(`✅ 結果追加: ${title?.substring(0, 50) || '無題'}... (信頼度: ${dateInfo.confidence})`);
                                            }
                                        }
                                    }
                                });
                                
                                if (foundContent) break;
                            }
                        }
                        
                        if (!foundContent) {
                            debugLog('📄 構造化コンテンツが見つからないため、ページ全体を評価');
                            const pageDate = extractDateWithHighPrecision(doc.body, doc);
                            
                            if (pageDate && pageDate.date >= cutoffDate) {
                                const pageTitle = doc.title || `${site.name}のページ`;
                                results.push({
                                    url: site.url,
                                    title: `${pageTitle}（キーワード: ${foundKeywords.join('、')}）`,
                                    keywords: foundKeywords,
                                    dateInfo: pageDate,
                                    siteName: site.name,
                                    content: bodyText.substring(0, 200).trim(),
                                    isNew: true
                                });
                                debugLog(`✅ ページ全体を追加: ${pageTitle}`);
                            } else if (!pageDate && includeUndated) {
                                const pageTitle = doc.title || `${site.name}のページ`;
                                results.push({
                                    url: site.url,
                                    title: `${pageTitle}（キーワード: ${foundKeywords.join('、')}）`,
                                    keywords: foundKeywords,
                                    dateInfo: {
                                        date: new Date(),
                                        confidence: 'unknown',
                                        source: '日付不明'
                                    },
                                    siteName: site.name,
                                    content: bodyText.substring(0, 200).trim(),
                                    isNew: true
                                });
                            }
                        }
                    } else {
                        debugLog('❌ キーワードが含まれていません');
                    }
                    
                } catch (error) {
                    console.error(`${site.name} でエラー:`, error);
                    debugLog(`❌ ${site.name} でエラー: ${error.message}`);
                }
                
                await new Promise(resolve => setTimeout(resolve, 1000));
            }
            
            debugLog(`🎉 スクレイピング完了: ${results.length}件`);
            return results;
        }

        function extractTitle(element, text) {
            const titleElement = element.querySelector('h1, h2, h3, h4, h5, h6, .title, [class*="title"], strong, b');
            if (titleElement) {
                return titleElement.innerText || titleElement.textContent || '';
            }
            
            if (element.tagName === 'A') {
                return element.innerText || element.textContent || '';
            }
            
            return text.substring(0, 100);
        }

        function extractUrl(element, baseUrl) {
            const linkElement = element.tagName === 'A' ? element : element.querySelector('a');
            if (linkElement && linkElement.href) {
                let url = linkElement.href;
                if (!url.startsWith('http')) {
                    try {
                        url = new URL(url, baseUrl).href;
                    } catch (e) {
                        url = baseUrl;
                    }
                }
                return url;
            }
            return baseUrl;
        }

        function displayResults(results, dayRange, showConfidence) {
            const resultsDiv = document.getElementById('results');
            
            if (results.length === 0) {
                const cutoffDate = new Date(Date.now() - dayRange * 24 * 60 * 60 * 1000);
                const dateRange = `${cutoffDate.toLocaleDateString('ja-JP')} ～ ${new Date().toLocaleDateString('ja-JP')}`;
                
                resultsDiv.innerHTML = `
                    <div class="no-results">
                        <h4>該当案件なし</h4>
                        <p><strong>検索期間:</strong> ${dateRange}（過去${dayRange}日間）</p>
                        <p><strong>監視キーワード:</strong> ${keywords.join('、')}</p>
                        <p><strong>監視サイト:</strong> ${sites.map(site => site.name).join('、')}</p>
                        <p>指定された期間内に該当するキーワードを含む記事は見つかりませんでした。</p>
                    </div>
                `;
                showStatus('該当する案件が見つかりませんでした', 'warning');
                return;
            }

            // 結果を日付順でソート
            results.sort((a, b) => new Date(b.dateInfo.date) - new Date(a.dateInfo.date));

            const cutoffDate = new Date(Date.now() - dayRange * 24 * 60 * 60 * 1000);
            const dateRange = `${cutoffDate.toLocaleDateString('ja-JP')} ～ ${new Date().toLocaleDateString('ja-JP')}`;
            
            let resultsHTML = `
                <h4>🏗️ ${results.length}件の建築設備関連案件が見つかりました</h4>
                <p style="color: #666; font-size: 0.9rem; margin-bottom: 15px;">
                    <strong>検索期間:</strong> ${dateRange}（過去${dayRange}日間）
                </p>
            `;
            
            results.forEach(result => {
                const publishedDate = new Date(result.dateInfo.date);
                const today = new Date();
                const diffTime = Math.abs(today - publishedDate);
                const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                
                const dateDisplay = publishedDate.toLocaleDateString('ja-JP', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    weekday: 'short'
                });
                
                // 新着ラベル
                let newLabel = '';
                if (diffDays === 0) {
                    newLabel = '<span style="background: #ff4444; color: white; padding: 2px 6px; border-radius: 3px; font-size: 0.8rem; margin-left: 8px;">本日</span>';
                } else if (diffDays === 1) {
                    newLabel = '<span style="background: #ff8800; color: white; padding: 2px 6px; border-radius: 3px; font-size: 0.8rem; margin-left: 8px;">昨日</span>';
                } else if (diffDays <= 3) {
                    newLabel = '<span style="background: #4CAF50; color: white; padding: 2px 6px; border-radius: 3px; font-size: 0.8rem; margin-left: 8px;">新着</span>';
                }
                
                // 信頼度バッジ
                let confidenceBadge = '';
                if (showConfidence) {
                    const confidenceText = {
                        'high': '高',
                        'medium': '中',
                        'low': '低',
                        'unknown': '不明'
                    }[result.dateInfo.confidence];
                    
                    confidenceBadge = `<span class="confidence-badge confidence-${result.dateInfo.confidence}" title="${result.dateInfo.source}">信頼度: ${confidenceText}</span>`;
                }
                
                const keywordList = result.keywords.join(', ');
                const itemClass = result.dateInfo.confidence === 'low' || result.dateInfo.confidence === 'unknown' ? 'result-item low-confidence' : 'result-item';
                
                resultsHTML += `
                    <div class="${itemClass}">
                        <div>
                            <a href="${result.url}" class="result-url" target="_blank" rel="noopener noreferrer">${result.url}</a>
                        </div>
                        <div style="margin-top: 8px; font-weight: 600; color: #333; display: flex; align-items: center; flex-wrap: wrap;">
                            ${result.title}${newLabel}${confidenceBadge}
                        </div>
                        ${result.content ? `<div style="margin-top: 5px; color: #555; font-size: 0.9rem;">${result.content.substring(0, 200)}${result.content.length > 200 ? '...' : ''}</div>` : ''}
                        <div class="result-keywords">
                            ${dateDisplay} | サイト: ${result.siteName} | 該当キーワード: ${keywordList}
                            ${showConfidence ? ` | 抽出ソース: ${result.dateInfo.source}` : ''}
                        </div>
                    </div>
                `;
            });

            resultsDiv.innerHTML = resultsHTML;
            showStatus(`${results.length}件の案件を発見しました`, 'success');
            debugLog(`📊 結果表示完了: ${results.length}件`);
        }

        function generateTestData(dayRange, showConfidence) {
            debugLog('🧪 テストデータ生成中...');
            const testResults = [];
            const today = new Date();
            
            const testData = [
                {
                    title: '市役所本庁舎 外壁改修工事の入札公告について',
                    keywords: ['入札', '改修', '工事'],
                    confidence: 'high',
                    source: 'JSON-LD:datePublished',
                    daysAgo: 2
                },
                {
                    title: '小学校 屋上防水工事 一般競争入札',
                    keywords: ['競争', '防水', '屋上'],
                    confidence: 'medium',
                    source: 'HTML:.date',
                    daysAgo: 5
                },
                {
                    title: '公民館 内装改装工事 オープンカウンタ方式',
                    keywords: ['オープンカウンタ', '内装', '改装'],
                    confidence: 'high',
                    source: 'メタ:article:published_time',
                    daysAgo: 1
                }
            ];
            
            testData.forEach((item, i) => {
                const testDate = new Date(today.getTime() - item.daysAgo * 24 * 60 * 60 * 1000);
                
                testResults.push({
                    url: `https://example-city.gov.jp/tender/${i + 1}`,
                    title: item.title,
                    keywords: item.keywords,
                    dateInfo: {
                        date: testDate,
                        confidence: item.confidence,
                        source: item.source
                    },
                    siteName: 'テスト自治体サイト',
                    content: 'これは高精度日付抽出機能のテスト用模擬データです。',
                    isNew: true
                });
            });
            
            debugLog(`✅ テストデータ生成完了: ${testResults.length}件`);
            return testResults;
        }

        // 初期化
        document.addEventListener('DOMContentLoaded', function() {
            debugLog('🚀 高精度日付抽出システム初期化開始');
            
            initializeKeywords();
            
            document.getElementById('siteInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') addSite();
            });

            document.getElementById('siteNameInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') addSite();
            });

            showStatus('v5.0 高精度日付抽出システムが準備できました', 'success');
            debugLog('✅ 初期化完了');
        });
    </script>
</body>
</html>
